<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>CNC CAM</title>
    <script src="libs/jquery.min.js"></script>
    <script src="libs/jquery.flot.min.js"></script>
    <script src="libs/jquery.flot.resize.js"></script>
    <script src="libs/Three.js"></script>
    <script src="libs/TrackballControls.js"></script>
    <script src="libs/jsparse.js"></script>
    <script src="libs/svg.js"></script>
    <script src="libs/svg.draggable.js"></script>
    <script src="libs/svg.memory.js"></script>
    <script src="libs/jquery.mousewheel.js"></script>
    <script src="libs/clipper_unminified.js"></script>
    <script src="cnc/cam.js"></script>
    <script src="cnc/geometry.js"></script>
    <script src="cnc/simulation.js"></script>
    <script src="cnc/parser.js"></script>
    <script src="cnc/threeDView.js"></script>
    <script src="cnc/twoDView.js"></script>
    <style>
        html, body {
            height: 100%;
        }

        body {
            background-color: white;
            display: flex;
            margin: 0;
        }

        .editBlock {
            display: flex;
            flex-direction: column;
            text-align: right;
            flex: 1;
        }

        .editBlock textarea {
            flex: 1;
        }

        .editBlock button {
            align-self: flex-end;
        }

        #views {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #container {
            background: #2F2F2F;
            flex: 1;
        }

        #drawing {
            flex: 1;
            overflow: hidden;
        }
    </style>
</head>
<body>
<div class="editBlock">
    <textarea id="codebox" placeholder="Paste your javascript here...">
        var toolDiameter = 5.5;
        var toolRadius = toolDiameter / 2;
        var stockThickness = 19;
        var travelZ = 5;
        var workZ = -19;

        machine.setParams(workZ, travelZ, 500);
        var plateWidth = 155;
        var plateHeight = 75;

        var switchWidth = 22;
        var switchHeight = 29;

        var switchTopMargin = 11;

        var plugHeight = 20.6;
        var plugWidth = 28.5;

        var plugCenterX = 40;

        var plugSwitchSeparation = 2;

        function cornerForCenter(centerCoord, width) {
        return centerCoord - width / 2;
        }

        var plateOutline = machine.createOutline('M0,0' + createRelativeRectangle(plateWidth, plateHeight));
        var switchBottom = plateHeight - switchTopMargin - switchHeight;
        var switchOutline = machine.createOutline('M' + cornerForCenter(plugCenterX, switchWidth) + ',' + switchBottom +
        createRelativeRectangle(switchWidth, switchHeight));
        var plugBottom = switchBottom - plugSwitchSeparation - plugHeight;
        var plugOutline = machine.createOutline('M' + cornerForCenter(plugCenterX, plugWidth) + ',' + plugBottom +
        createRelativeRectangle(plugWidth, plugHeight));

        function makeToolPath(outline, inside) {
        var toolpath = machine.rampToolPath(machine.contouring(outline, toolRadius, inside, false)[0], 0, workZ, 3);
        machine.registerToolPath(toolpath);

        }

        makeToolPath(switchOutline, true);
        makeToolPath(plugOutline, true);
        makeToolPath(plateOutline, false);
    </textarea>
    <button id="simulationButton">Simulate</button>
</div>
<div id="views">
    <div id="container"></div>
    <div id="drawing"></div>
</div>
<script>
    var threeDView = new ThreeDView($('#container'));
</script>
<script>
    window.addEventListener("message", function (event) {
        if (event.data['type'] == 'gimme program') {
            evaluateCode();
            event.source.postMessage({type: 'program', program: $('#codebox').val()}, event.origin);
        }
        if (event.data['type'] == 'toolPosition') {
            var pos = event.data['position'];
            threeDView.tool.position.setX(pos.x);
            threeDView.tool.position.setY(pos.y);
            threeDView.tool.position.setZ(pos.z);
            threeDView.tool.traverse(function (child) {
                child.visible = true;
            });
            threeDView.renderer.render(threeDView.scene, threeDView.camera);
        }
    }, false);
</script>
<script>
    var twoDView = new TwoDView($('#drawing'));
    var codebox = $('#codebox');
    var code = localStorage.getItem('code');
    if (code)
        codebox.text(code);
    codebox.change(function () {
        localStorage.setItem('code', codebox.val());
    });
    var button = $('#simulationButton');
    var machine = null;
    function refresh() {
        machine = new Machine(twoDView.paper);
        twoDView.clear();
        eval(codebox.val());
        twoDView.zoomExtent();
        threeDView.displayPath(machine.dumpPath());
    }
    button.click(function () {
        refresh();
    });
    refresh();
</script>
</body>
</html>

