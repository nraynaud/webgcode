<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>CNC CAM</title>
    <script src="libs/jquery.min.js"></script>
    <script src="libs/jquery.flot.min.js"></script>
    <script src="libs/jquery.flot.resize.js"></script>
    <script src="libs/Three.js"></script>
    <script src="libs/TrackballControls.js"></script>
    <script src="libs/jsparse.js"></script>
    <script src="libs/svg.js"></script>
    <script src="libs/svg.draggable.js"></script>
    <script src="libs/svg.memory.js"></script>
    <script src="libs/jquery.mousewheel.js"></script>
    <script src="libs/clipper_unminified.js"></script>
    <script src="cnc/cam.js"></script>
    <script src="cnc/geometry.js"></script>
    <script src="cnc/simulation.js"></script>
    <script src="cnc/parser.js"></script>
    <style>
        html, body {
            height: 100%;
        }

        body {
            background-color: white;
            display: flex;
            margin: 0;
        }

        .editBlock {
            display: flex;
            flex-direction: column;
            text-align: right;
            flex: 1;
        }

        .editBlock textarea {
            flex: 1;
        }

        .editBlock button {
            align-self: flex-end;
        }

        #views {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #container {
            background: #2F2F2F;
            flex: 1;
        }

        #drawing {
            flex: 1;
        }
    </style>
</head>
<body>
<div class="editBlock">
    <textarea id="codebox" placeholder="Paste your javascript here...">

        var toolDiameter = 3.2;
        var toolRadius = toolDiameter / 2;
        var stockThickness = 19;
        var travelZ = 10;
        var workZ = -19;
        var length = 43;
        var width = 40;
        var grooveToSide = 11.5;
        var grooveDepth = 5.5;

        function lineTo(x, y) {
        return 'l' + x + ',' + y;
        }

        var shape = lineTo(0, grooveToSide) + lineTo(4, 0) + lineTo(0, width - 2 * grooveToSide) + lineTo(-4, 0) +
        lineTo(0, grooveToSide) + lineTo(length, 0) + lineTo(0, -width) + 'z';
        var rectangle = createOutline('M0,0' + shape);
        var rectangleToolPath = contouring(rectangle, toolRadius, false, false);

        showClipperPolygon(paper, rectangleToolPath, 'blue');
    </textarea>
    <button id="simulationButton">Simulate</button>
</div>
<div id="views">
    <div id="container"></div>
    <div id="drawing"></div>
</div>
<script>
    var $container = $('#container');
    var WIDTH = $container.width();
    var HEIGHT = $container.height();
    var mouse = new THREE.Vector2(), INTERSECTED;
    projector = new THREE.Projector();
    raycaster = new THREE.Raycaster();
    var renderer = new THREE.WebGLRenderer({antialias: true});
    var camera = new THREE.PerspectiveCamera(45, WIDTH / HEIGHT, 0.1, 20000);
    var scene = new THREE.Scene();
    camera.position.x = 30;
    camera.position.y = 30;
    camera.position.z = 30;
    camera.up.set(0, 0, 1);
    renderer.setSize(WIDTH, HEIGHT);
    function resize() {
        camera.aspect = $container.width() / $container.height();
        camera.updateProjectionMatrix();
        renderer.setSize($container.width(), $container.height());
        renderer.render(scene, camera);
    }
    $(window).resize(resize);
    $container.append(renderer.domElement);
    scene.add(camera);
    controls = new THREE.TrackballControls(camera, $container[0]);
    controls.rotateSpeed = 1.0;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.8;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = true;
    controls.dynamicDampingFactor = 0.3;
    controls.minDistance = 3;
    controls.keys = [ 65, 83, 68 ];
    controls.addEventListener('change', function () {
        renderer.render(scene, camera);
    });
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
    }
    var mesh = null;
    var contourMesh = null;
    var contourLines = [];
    var planeGeometry = new THREE.PlaneGeometry(10, 10, 5, 5);
    scene.add(new THREE.Mesh(planeGeometry, new THREE.MeshBasicMaterial({wireframe: true, color: 0x00CC00})));
    function createAxis(x, y, z, color) {
        var geom = new THREE.Geometry();
        geom.vertices.push(new THREE.Vector3(0, 0, 0));
        geom.vertices.push(new THREE.Vector3(x, y, z));
        return new THREE.Line(geom, new THREE.LineBasicMaterial({color: color}));
    }
    var axes = new THREE.Object3D();
    axes.add(createAxis(10, 0, 0, 0xFF0000));
    axes.add(createAxis(0, 10, 0, 0x00FF00));
    axes.add(createAxis(0, 0, 10, 0x0000FF));
    scene.add(axes);
    var tool = new THREE.Object3D();
    var toolbit = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 10, 20, 2, false), new THREE.MeshPhongMaterial({emissive: 0xEF0000, specular: 0x0F0000, shininess: 204, color: 0xF0F0F0, opacity: 0.5, transparent: true}));
    toolbit.translateY(5);
    var spindle = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 15, 25, 2, false), new THREE.MeshPhongMaterial({emissive: 0xEFEFEF, specular: 0x0F0F0F, shininess: 204, color: 0xF0F0F0, opacity: 0.5, transparent: true}));
    spindle.translateY(17.5);
    tool.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI / 2));
    tool.add(toolbit);
    tool.add(spindle);
    tool.matrixAutoUpdate = true;
    scene.add(tool);
    animate();
</script>
<script>
    window.addEventListener("message", function (event) {
        if (event.data['type'] == 'gimme program') {
            evaluateCode();
            event.source.postMessage({type: 'program', program: $('#codebox').val()}, event.origin);
        }
        if (event.data['type'] == 'toolPosition') {
            var pos = event.data['position'];
            var toolPos = $('#toolPos');
            toolPos.attr('translation', [pos.x, pos.y, pos.z].join(' '));
            toolPos.attr('render', true);
            tool.position.setX(pos.x);
            tool.position.setY(pos.y);
            tool.position.setZ(pos.z);
            tool.traverse(function (child) {
                child.visible = true;
            });
            renderer.render(scene, camera);
        }
    }, false);
    //evaluateCode();
</script>
<script>
    var drawing = $('#drawing');
    var svg = SVG(drawing[0]).size(drawing.width(), drawing.height());
    var paper = svg.group().attr({id: 'root', 'vector-effect': 'non-scaling-stroke'});
    function setMatrix(element, matrix) {
        var components = $.map('abcdef'.split(''),function (c) {
            return matrix[c];
        }).join(',');
        element.attr({transform: 'matrix(' + components + ')'});
    }
    drawing.mousewheel(function (event, delta) {
        if (typeof event.offsetX === "undefined" || typeof event.offsetY === "undefined") {
            var targetOffset = $(event.target).offset();
            event.offsetX = event.pageX - targetOffset.left;
            event.offsetY = event.pageY - targetOffset.top;
        }
        var svgRoot = paper.node;
        var p = svg.node.createSVGPoint();
        p.x = event.offsetX;
        p.y = event.offsetY;
        p = p.matrixTransform(svgRoot.getCTM().inverse());
        var k = svg.node.createSVGMatrix().translate(p.x, p.y).scale(1 + delta / 360).translate(-p.x, -p.y);
        var m = svgRoot.getCTM().multiply(k);
        setMatrix(paper, m);
        event.preventDefault();
    });
    function zoomExtent(paper) {
        var box = paper.bbox();
        var m = paper.node.getCTM();
        var newScale = Math.min(svg.node.width.baseVal.value / box.width, svg.node.height.baseVal.value / box.height) * 0.9;
        m.a = newScale;
        m.d = -newScale;
        m.e = -box.x + box.width * 0.25;
        m.f = -(-box.y + box.height * 0.5 - svg.node.height.baseVal.value);
        setMatrix(paper, m);
    }
    zoomExtent(paper);
    $(window).resize(function resizeSVG() {
        svg.size(drawing.width(), drawing.height());
    });
    var button = $('#simulationButton');
    button.click(function () {
        eval($('#codebox').val());
        zoomExtent(paper);
    });

    eval($('#codebox').val());
    zoomExtent(paper);
</script>
</body>
</html>

