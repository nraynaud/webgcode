<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>g-code simulator</title>
    <script src="webapp/libs/jquery.min.js"></script>
    <script src="webapp/libs/jquery.flot.min.js"></script>
    <script src="webapp/libs/jquery.flot.resize.js"></script>
    <script src="webapp/libs/Three.js"></script>
    <script src="webapp/libs/TrackballControls.js"></script>
    <script src="webapp/libs/ace/src-noconflict/ace.js"></script>
    <script src="webapp/libs/require.js"></script>

    <script>
        requirejs.config({
            baseUrl: 'webapp'
        });
    </script>

    <style>
        .editBlock {
            position: relative;
            float: left;
            width: 49%;
            height: 400px;
            padding: 1px;
            margin: 0;
        }

        .editBlock pre {
            width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            height: 350px;
        }

        .chart {
            position: relative;
            clear: both;
            width: 100%;
            height: 200px;
        }

        #container {
            float: right;
            background: #000;
            width: 50%;
            height: 400px;
        }
    </style>
</head>
<body>

<h1>G-Code Q'n'dirty toolpath simulator</h1>

<p>
    Paste your g-code in the left window and see the 3D preview of your toolpath on the right.<br>
    The right pane is interactive, drag it to change the point of view.
</p>

<p>
    <a href="https://github.com/nraynaud/webgcode/tree/gh-pages">https://github.com/nraynaud/webgcode/tree/gh-pages</a>
</p>

<div id="container"></div>
<div class="editBlock">
    <pre id="codebox">
        G0 Y10 Z-5
        G1 Z-10
        G1 Y20
        G02 X10 Y30 R10
        G1 X30
        G2 X40 Y20 R10
        G1 Y10
        G2 X30 Y0 R10
        G1 X10
        G2 X0 Y10 Z-15 R10 (yeah spiral !)
        G3 X-10 Y20 R-10 (yeah, long arc !)
        G3 X0 Y10 I10 (center)
        G91 G1 X10 Z10
        G3 Y10 R5 Z3 (circle in incremental)
        Y10 R5 Z3 (again, testing modal state)
        G20 G0 X1 (one inch to the right)
        G3 X-1 R1 (radius in inches)
        G3 X1 Z0.3 I0.5 J0.5 (I,J in inches)
        G21 (back to mm)
        G80 X10 (do nothing)
        G90
        G0 X30 Y30 Z30
        G18 (X-Z plane)
        G3 Z40 I0 K5
        G19 (Y-Z plane)
        G3 Z50 J0 K5
        G17 (back to X-Y plane)
    </pre>
    <button id="simulateButton">Simulate</button>
</div>
<div class="chart" id="chart1"></div>
<div class="chart" id="chart2"></div>
<div class="chart" id="chart3"></div>
<script>
    require(['cnc/threeDView', 'cnc/util', 'cnc/parser', 'cnc/simulation'], function (threeD, util, parser, simulation) {
        var editor = ace.edit("codebox");
        editor.setTheme("ace/theme/twilight");

        function refreshView() {
            var text = editor.getValue();

            var simulatedPath = [];
            var posData = [
                {label: 'x position(s->mm)', shadowSize: 0, color: 'red', data: []},
                {label: 'y position(s->mm)', shadowSize: 0, color: 'green', data: []},
                {label: 'z position(s->mm)', shadowSize: 0, color: 'blue', data: []}
            ];

            var speedData = [
                {label: 'x speed(s->mm/s)', shadowSize: 0, color: 'red', data: [
                    [0, 0]
                ]},
                {label: 'y speed(s->mm/s)', shadowSize: 0, color: 'green', data: [
                    [0, 0]
                ]},
                {label: 'z speed(s->mm/s)', shadowSize: 0, color: 'blue', data: [
                    [0, 0]
                ]},
                {label: '|speed|(s->mm/s)', shadowSize: 0, color: 'rgba(0, 0, 0, 0.4)', data: [
                    [0, 0]
                ]}
            ];
            var accelerationData = [
                {label: 'x acc(s->mm/s^2)', shadowSize: 0, color: 'red', data: [
                    [0, 0]
                ]},
                {label: 'y acc(s->mm/s^2)', shadowSize: 0, color: 'green', data: [
                    [0, 0]
                ]},
                {label: 'z acc(s->mm/s^2)', shadowSize: 0, color: 'blue', data: [
                    [0, 0]
                ]},
                {label: '|acceleration|(s->mm/s^2)', shadowSize: 0, color: 'rgba(0, 0, 0, 0.4)', data: [
                    [0, 0]
                ]}
            ];

            function pushPoint(x, y, z, t) {
                posData[0].data.push([t, x]);
                posData[1].data.push([t, y]);
                posData[2].data.push([t, z]);
                simulatedPath.push({x: x, y: y, z: z});
                var previous = posData[0].data.length - 2;
                if (previous >= 0) {
                    var previousDate = posData[0].data[previous][0];
                    var dt = t - previousDate;
                    var speedDate = (t + previousDate) / 2;
                    var dx = x - posData[0].data[previous][1];
                    var dy = y - posData[1].data[previous][1];
                    var dz = z - posData[2].data[previous][1];
                    var sx = dx / dt;
                    var sy = dy / dt;
                    var sz = dz / dt;
                    speedData[0].data.push([speedDate, sx]);
                    speedData[1].data.push([speedDate, sy]);
                    speedData[2].data.push([speedDate, sz]);
                    speedData[3].data.push([speedDate, util.length(dx, dy, dz) / dt]);
                    if (previous >= 1) {
                        var previousSpeedDate = speedData[0].data[previous - 1][0];
                        var pDSx = sx - speedData[0].data[previous - 1][1];
                        var pDSy = sy - speedData[1].data[previous - 1][1];
                        var pDSz = sz - speedData[2].data[previous - 1][1];
                        var accelerationDate = (previousSpeedDate + speedDate) / 2;
                        accelerationData[0].data.push([accelerationDate, pDSx / (speedDate - previousSpeedDate)]);
                        accelerationData[1].data.push([accelerationDate, pDSy / (speedDate - previousSpeedDate)]);
                        accelerationData[2].data.push([accelerationDate, pDSz / (speedDate - previousSpeedDate)]);
                        accelerationData[3].data.push([accelerationDate, util.length(pDSx, pDSy, pDSz) / (speedDate - previousSpeedDate)]);
                    }
                }
            }

            simulation.simulate2(parser.evaluate(text), pushPoint);
            threeDView.displayPath(simulatedPath);
            var chart1 = $.plot("#chart1", posData);
            $.plot("#chart2", speedData, {xaxis: {max: chart1.getAxes().xaxis.max}});
            $.plot("#chart3", accelerationData, {xaxis: {max: chart1.getAxes().xaxis.max}});
        }

        $('#simulateButton').click(refreshView);
        function getURLParameter(name) {
            return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
        }

        var threeDView = new threeD.ThreeDView($('#container'));
        refreshView();
    });
</script>
</body>
</html>

