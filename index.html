<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>g-code simulator</title>
    <script src="webapp/libs/jquery.min.js"></script>
    <script src="webapp/libs/jquery.flot.min.js"></script>
    <script src="webapp/libs/jquery.flot.resize.js"></script>
    <script src="webapp/libs/Three.js"></script>
    <script src="webapp/libs/TrackballControls.js"></script>
    <script src="webapp/libs/ace/src-noconflict/ace.js"></script>
    <script src="webapp/libs/require.js"></script>
    <script src="webapp/libs/handlebars-v1.3.0.js"></script>
    <script src="webapp/libs/ember-1.5.0-beta5.pre7.js"></script>

    <script>
        requirejs.config({
            baseUrl: 'webapp',
            paths: {
                text: 'libs/require_text'
            }
        });
    </script>

    <style>
        .editBlock {
            position: relative;
            float: left;
            width: 49%;
            height: 400px;
            padding: 1px;
            margin: 0;
        }

        .editBlock pre {
            width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            height: 350px;
            margin: 0;
        }

        #container {
            float: right;
            background: #000;
            width: 50%;
            height: 400px;
        }

        #loader {
            display: inline-block;
            background-size: 100% 100%;
            background-image: url(webapp/spinner.svg);
            width: 20px;
            height: 20px;
        }

        .boundsTable {
            border-collapse: collapse;
        }

        .boundsTable td {
            border: dashed gray 1px;
            padding: 3px;
        }
    </style>
</head>
<body>

<h1>G-Code Q'n'dirty toolpath simulator</h1>

<p>
    Paste your g-code in the left window and see the 3D preview of your toolpath on the right.<br>
    The right pane is interactive, drag it to change the point of view.
</p>

<p>
    <a href="https://github.com/nraynaud/webgcode/tree/gh-pages">https://github.com/nraynaud/webgcode/tree/gh-pages</a>
</p>

<div id="container"></div>
<div id="app" class="editBlock"></div>
<script type="text/x-handlebars" data-template-name="application">
    {{ace-editor content=code annotations=errors lineSegmentMap=lineSegmentMap}}
    <button id="simulateButton"
    {{action "simulate"}}>Simulate</button>
    <div id="loader">&nbsp;</div>
    <div>
        <dl>
            <dt>Total Duration:</dt>
            <dd>{{num totalTime}}s</dd>
        </dl>
        <dl>
            <dt>Bounds (@tool center):</dt>
            <dd>
                <table class="boundsTable" style="text-align:right;">
                    <thead>
                    <tr>
                        <th>&nbsp;</th>
                        <th>min</th>
                        <th>max</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <th>X</th>
                        <td>{{num bbox.min.x}}</td>
                        <td>{{num bbox.max.x}}</td>
                    </tr>
                    <tr>
                        <th>Y</th>
                        <td>{{num bbox.min.y}}</td>
                        <td>{{num bbox.max.y}}</td>
                    </tr>
                    <tr>
                        <th>Z</th>
                        <td>{{num bbox.min.z}}</td>
                        <td>{{num bbox.max.z}}</td>
                    </tr>
                    </tbody>
                </table>
            </dd>
        </dl>
    </div>
</script>

<script type="text/x-handlebars" data-template-name="components/ace-editor">
    <pre id="codebox">
    </pre>
</script>

<script>
    require(['cnc/threeDView', 'cnc/util'], function (threeD, util) {
        var demoCode = 'G0 Y10 Z-5\n' +
                'G1 Z-10\n' +
                'G1 Y20\n' +
                'G02 X10 Y30 R10\n' +
                'G1 X30\n' +
                'G2 X40 Y20 R10\n' +
                'G1 Y10\n' +
                'G2 X30 Y0 R10\n' +
                'G1 X10\n' +
                'G2 X0 Y10 Z-15 R10 (yeah spiral !)\n' +
                'G3 X-10 Y20 R-10 (yeah, long arc !)\n' +
                'G3 X0 Y10 I10 (center)\n' +
                'G91 G1 X10 Z10\n' +
                'G3 Y10 R5 Z3 (circle in incremental)\n' +
                'Y10 R5 Z3 (again, testing modal state)\n' +
                'G20 G0 X1 (one inch to the right)\n' +
                'G3 X-1 R1 (radius in inches)\n' +
                'G3 X1 Z0.3 I0.5 J0.5 (I,J in inches)\n' +
                'G21 (back to mm)\n' +
                'G80 X10 (do nothing)\n' +
                'G90\n' +
                'G0 X30 Y30 Z30\n' +
                'G18 (X-Z plane)\n' +
                'G3 Z40 I0 K5\n' +
                'G19 (Y-Z plane)\n' +
                'G3 Z50 J0 K5\n' +
                'G17 (back to X-Y plane)\n';

        function parseInWorker(code, resultHandler) {
            var worker = new Worker('webapp/worker.js');
            window.myWorker = worker;
            worker.onmessage = function (event) {
                resultHandler(event.data);
                window.myWorker = null;
            };
            worker.postMessage({
                operation: 'simulateGCode',
                code: code
            });
        }

        function parseImmediately(code, resultHandler) {
            require(['cnc/gcodeSimulation'], function (gcodeSimulation) {
                resultHandler(gcodeSimulation.simulateGCode(code));
            });
        }

        var threeDView = new threeD.ThreeDView($('#container'));
        Ember.Handlebars.helper('num', function (value) {
            return new Handlebars.SafeString(Handlebars.Utils.escapeExpression(util.formatCoord(value)));
        });
        window.Simulator = Ember.Application.create({
            rootElement: '#app'
        });
        Simulator.AceEditorComponent = Em.Component.extend({
            didInsertElement: function () {
                var _this = this;
                this.set('editor', window.ace.edit("codebox"));
                this.get('editor').setTheme("ace/theme/twilight");
                this.get('editor').on('mousemove', function (event) {
                    var lineNo = event.getDocumentPosition().row;
                    var highlight = _this.get('lineSegmentMap')[lineNo];
                    if (highlight)
                        threeDView.displayHighlight(highlight);
                    else
                        threeDView.hideHighlight();
                });
                $('#codebox').on('mouseout', function () {
                    threeDView.hideHighlight();
                });
                this.get('editor').on('change', function () {
                    Em.run.once(_this, _this.notifyPropertyChange, 'content');
                });
                if (this.get('preset')) {
                    this.set('content', this.get('preset'));
                    this.set('preset', null);
                }
            },
            content: function (key, val) {
                if (!this.get('editor')) {
                    this.set('preset', val);
                    return val;
                }
                if (arguments.length == 1) {
                    return this.get('editor').getSession().getValue();
                } else {
                    this.get('editor').getSession().setValue(val);
                    return val;
                }
            }.property(),
            annotations: function (key, val) {
                if (!this.get('editor'))
                    return val;
                if (arguments.length == 1)
                    return this.get('editor').getSession().getAnnotations();
                else {
                    this.get('editor').getSession().setAnnotations(val);
                    if (val.length)
                        this.get('editor').gotoLine(val[0].row);
                    return val;
                }
            }.property()
        });

        Simulator.ApplicationController = Ember.ObjectController.extend({
            init: function () {
                this._super();
                this.launchSimulation();
            },
            actions: {
                simulate: function () {
                    this.launchSimulation();
                }
            },
            launchSimulation: function () {
                var _this = this;

                function handleResult(result) {
                    threeDView.displayPath(result.simulatedPath);
                    console.timeEnd('simulation');
                    var errors = [];
                    for (var i = 0; i < result.errors.length; i++) {
                        var error = result.errors[i];
                        errors.push({row: error.lineNo, text: error.message, type: "error"});
                    }
                    _this.set('errors', errors);
                    _this.set('bbox', {min: result.min, max: result.max});
                    _this.set('totalTime', result.totalTime);
                    _this.set('lineSegmentMap', result.lineSegmentMap);
                    $('#loader').hide();
                    $('#simulateButton').prop('disabled', false);
                }

                threeDView.clearToolpath();
                $('#loader').show();
                $('#simulateButton').prop('disabled', true);
                var code = this.get('code');
                try {
                    parseInWorker(code, handleResult);
                } catch (error) {
                    console.log('worker error', error);
                    console.log('trying again without worker');
                    parseImmediately(code, handleResult)
                }
            },
            code: demoCode,
            errors: [],
            bbox: {},
            totalTime: 0,
            lineSegmentMap: []
        });
    });
</script>
</body>
</html>

