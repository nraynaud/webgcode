<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>g-code simulator</title>
    <script src="webapp/libs/require.js"></script>
    <script src="/webapp/definitions.js"></script>
    <script src="webapp/config.js"></script>
    <script>
        requirejs.config({
            baseUrl: 'webapp'
        });
    </script>

    <link rel="shortcut icon" href="webapp/images/icon_fraise_48.png"/>
    <link rel="stylesheet" href="webapp/twoDView.css" type="text/css">
    <link rel="stylesheet" href="webapp/threeDView.css" type="text/css">
</head>
<body>
<div id="app">
    <div id="container"></div>
</div>

<script src="/webapp/monacoeditor.js"></script>
<script>
    window.registerUIThings = setInterval(() => {
        if (window.editor == undefined) return;
        clearInterval(window.registerUIThings);
    
        require(['Ember', 'cnc/ui/graphicView', 'cnc/cam/cam', 'cnc/util', 'cnc/ui/gcodeEditor', 'cnc/gcode/gcodeSimulation', 'templates'],
            function (Ember, GraphicView, cam, util, gcodeEditor, gcodeSimulation) {
                // var demoCode = $('#demoCode').text();

                Ember.Handlebars.helper('num', function (value) {
                    return new Handlebars.SafeString(Handlebars.Utils.escapeExpression(util.formatCoord(value)));
                });
                Ember.TEMPLATES['application'] = Ember.TEMPLATES['camApp'];

                window.Simulator = Ember.Application.create({
                    rootElement: '#app'
                });

                Simulator.GcodeEditorComponent = gcodeEditor.GcodeEditorComponent;
                Simulator.GraphicView = GraphicView;

                Simulator.ApplicationController = Ember.ObjectController.extend({
                    init: function () {
                        this._super();
                        var _this = this;
                        $(window).on('dragover', function (event) {
                            event.preventDefault();
                            event.dataTransfer.dropEffect = 'move';
                        });

                        $(window).on('drop', function (evt) {
                            evt.preventDefault();
                            evt.stopPropagation();
                            var files = evt.dataTransfer.files;
                            var file = files[0];
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                _this.set('code', e.target.result);
                                _this.launchSimulation();
                            };
                            reader.readAsText(file);
                        });
                        this.launchSimulation();
                    },
                    actions: {
                        simulate: function () {
                            this.launchSimulation();
                        },
                        loadBigSample: function () {
                            this.set('computing', true);
                            var _this = this;
                            require(['text!samples/aztec_calendar.ngc'], function (text) {
                                _this.set('code', text);
                                _this.launchSimulation();
                            });
                        }
                    },
                    launchSimulation: function () {
                        var _this = this;

                        function handleResult(result) {
                            _this.flushFragmentFile();
                            var errors = [];
                            for (var i = 0; i < result.errors.length; i++) {
                                var error = result.errors[i];
                                errors.push({row: error.lineNo, text: error.message, type: "error"});
                            }
                            _this.set('errors', errors);
                            _this.set('bbox', {min: result.min, max: result.max});
                            _this.set('totalTime', result.totalTime);
                            _this.set('lineSegmentMap', result.lineSegmentMap);
                            _this.set('computing', false);
                            console.timeEnd('simulation');
                        }

                        console.time('simulation');
                        this.set('computing', true);
                        _this.set('lineSegmentMap', []);
                        this.get('simulatedPath').clear();
                        gcodeSimulation.parseInWorker(this.get('code'), new util.Point(0, 0, 0),
                                Ember.run.bind(_this, handleResult),
                                Ember.run.bind(_this, function (fragment) {
                                    _this.get('fragmentFile').pushObject(fragment);
                                    Ember.run.throttle(_this, _this.flushFragmentFile, 500);
                                }));
                    },
                    flushFragmentFile: function () {
                        this.get('simulatedPath').pushObjects(this.get('fragmentFile'));
                        this.get('fragmentFile').clear();
                    },
                    formattedTotalTime: function () {
                        var totalTime = this.get('totalTime');
                        var humanized = util.humanizeDuration(totalTime);
                        return {humanized: humanized, detailed: Math.round(totalTime) + 's'};
                    }.property('totalTime'),
                    currentHighLight: function () {
                        return this.get('lineSegmentMap')[this.get('currentRow')];
                    }.property('currentRow', 'lineSegmentMap').readOnly(),
                    code: localStorage.getItem('text-content') != undefined ? localStorage.getItem('text-content') : DEFAULT_EDITOR_VALUE,
                    errors: [],
                    bbox: {},
                    totalTime: 0,
                    lineSegmentMap: [],
                    currentRow: null,
                    simulatedPath: [],
                    computing: false,
                    fragmentFile: [],
                    canSelectLanguage: false,
                    usingGcode: true,
                    decorations: []
                });
            });
        });
</script>

<script>
window.killMe = setInterval(() => {
    elem = document.getElementsByClassName('ember-view viewContainer');
    if (elem.length == 0) return;
    elem = elem[0];

    // make the position absolute, and move it to the top right
    elem.style.position = 'absolute';
    elem.style.top = '0';
    elem.style.right = '0';
    // make the max width 45% of the screen
    elem.style.maxWidth = '45%';

    document.getElementById('ember290').remove();
    document.getElementsByClassName('3DWarning')[0].remove();
    clearInterval(window.killMe);
}, 100);
</script>

</body>
</html>

<script>
    promptAndLoadFile = () => {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.gcode';
        input.click();

        input.onchange = e => { 
            var file = e.target.files[0]; 
            var reader = new FileReader();

            reader.readAsText(file,'UTF-8');
            reader.onload = readerEvent => {
                var content = readerEvent.target.result;
                window.editor.setValue(content);
                localStorage.setItem('text-content', content);
            }
        }
    };

    saveAs = (uri, filename) => {
        var link = document.createElement('a');
        if (typeof link.download === 'string') {
            document.body.appendChild(link); // Firefox requires the link to be in the body
            link.download = filename;
            link.href = uri;
            link.click();
            document.body.removeChild(link); // remove the link when done
        } else {
            location.replace(uri);
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveAs(`data:application/octet-stream,${window.editor.getValue()}`, 'file.gcode');
        }
    });

    window.illdielater = setInterval(() => {
        if (document.getElementsByClassName('editBlock').length == 0 || window.editor == undefined) return;

        const editBlock = document.getElementsByClassName('editBlock')[0];

        const simulateButton = document.getElementsByClassName('editBlock')[0].getElementsByTagName('button')[0];
        const loadBigSampleButton = document.getElementsByClassName('editBlock')[0].getElementsByTagName('button')[1];

        simulateButton.style.display = 'none';
        loadBigSampleButton.style.display = 'none';

        const newSimulateButton = document.createElement('button');
        newSimulateButton.classList.add('button');
        newSimulateButton.innerHTML = 'Simulate';
        newSimulateButton.style.marginRight = '5px';
        
        const openFile = document.createElement('button');
        openFile.classList.add('button');
        openFile.innerHTML = 'Open File';

        const toggleButtonContainer = document.createElement('div');
        toggleButtonContainer.classList.add('toggleButtonContainer');

        const liveReloadButton = document.createElement('input');
        liveReloadButton.type = 'checkbox';
        liveReloadButton.classList.add('checkbox');
        liveReloadButton.id = 'liveReload';

        const liveReloadLabel = document.createElement('label');
        liveReloadLabel.innerHTML = 'Live Reload';
        liveReloadLabel.classList.add('checkbox-label');
        liveReloadButton.for = 'liveReload';

        const suggestionsToggleButton = document.createElement('input');
        suggestionsToggleButton.type = 'checkbox';
        suggestionsToggleButton.id = 'suggestionsToggle';
        suggestionsToggleButton.classList.add('checkbox');

        const suggestionsToggleLabel = document.createElement('label');
        suggestionsToggleLabel.innerHTML = 'Suggestions';
        suggestionsToggleLabel.classList.add('checkbox-label')
        suggestionsToggleLabel.for = 'suggestionsToggle';

        // Original simulate button
        simulateButton.addEventListener('click', () => {
            window.clearMarkers(window.editor);
        })

        newSimulateButton.addEventListener('click', () => {
            window.TwoDForceUpdate = true;
            window.ThreeDForceUpdate = true;
            simulateButton.click();
        });

        openFile.addEventListener('click', () => {
            promptAndLoadFile();
        });

        liveReloadButton.addEventListener('change', () => {
            if (liveReloadButton.checked) {
                localStorage.setItem('liveReload', 'true');
            } else {
                localStorage.setItem('liveReload', 'false');
            }
        });

        suggestionsToggleButton.addEventListener('change', () => {
            if (suggestionsToggleButton.checked){
                localStorage.setItem('suggestionsToggle', 'true');
            } else {
                localStorage.setItem('suggestionsToggle', 'false');
            }
        });

        liveReloadButton.checked = localStorage.getItem('liveReload') == 'true';
        suggestionsToggleButton.checked = localStorage.getItem('suggestionsToggle') == 'true';
        
        const toolbarContainer = document.createElement('div');
        toolbarContainer.style.display = 'inline-flex';
        toolbarContainer.style.display = 'flex-direction: row';

        // insert the buttons before the old ones
        // editBlock.insertBefore(newSimulateButton, simulateButton);
        // editBlock.insertBefore(openFile, loadBigSampleButton);
        toolbarContainer.append(newSimulateButton, openFile);

        const liveReloadContainer = document.createElement('div');
        liveReloadContainer.style.display = 'inline';
        liveReloadContainer.append(liveReloadButton, liveReloadLabel);

        const suggestionsContainer = document.createElement('div');
        suggestionsContainer.style.display = 'inline';
        suggestionsContainer.append(suggestionsToggleButton, suggestionsToggleLabel);

        toggleButtonContainer.append(liveReloadContainer, suggestionsContainer);
        
        toolbarContainer.append(toggleButtonContainer);
        editBlock.insertBefore(toolbarContainer, loadBigSampleButton);

        clearInterval(illdielater);
    })
</script>

<style>
    body, html {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        position: absolute;
        height: 100%;
        width: 100%;
        margin: 0;
        background-color: #171616;
        color: white;
    }

    body {
        padding-left: 8px;
        padding-right: 8px;
        overflow: auto;
        overflow-x: hidden;
    }

    h1 {
        margin-top: 0;
    }

    #container {
        margin-top: 10px;
        margin-left: 10px;
        height: 600px;
        width: 45%;
    }

    .editBlock {
        position: relative;
        float: left;
        width: 39%;
        height: fit-content;
        padding: 1px;
        margin: 0;
        margin-left: 10px;
        margin-top: 10px;
    }

    .toggleButtonContainer {
        display: inline-flex;
        flex-direction: column;
    }

    .editBlock pre {
        width: 100%;
        height: 350px;
        margin: 0;
    }

    .viewContainer {
        float: right;
        width: 60%;
    }

    .button {
        display: inline-block;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007BFF; /* Button background color */
        color: #FFFFFF; /* Button text color */
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .button:hover {
        background-color: #0056b3; /* Button background color on hover */
    }

    #loader {
        display: inline-block;
        background-size: 100% 100%;
        background-image: url(webapp/images/spinner.svg);
        width: 20px;
        height: 20px;
    }

    .boundsTable {
        border-collapse: collapse;
    }

    .boundsTable td {
        border: dashed gray 1px;
        padding: 3px;
    }

    .ThreeDView {
        border: solid gray 1px;
        background: #000;
        height: 400px;
        position: relative;
    }

    .TwoDView {
        border: solid gray 1px;
        background: #000;
        height: 400px;
    }

    #app {
        position: relative;
    }
</style>