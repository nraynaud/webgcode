<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>g-code simulator</title>
    <script src="webapp/popup.js"></script>
    <script src="webapp/libs/require.js"></script>
    <script src="/webapp/definitions.js"></script>
    <script src="webapp/config.js"></script>
    <script>
        requirejs.config({
            baseUrl: 'webapp'
        });
    </script>

    <link rel="stylesheet" href="webapp/popup.css" type="text/css"/>
    <link rel="shortcut icon" href="webapp/images/icon_fraise_48.png"/>
    <link rel="stylesheet" href="webapp/twoDView.css" type="text/css">
    <link rel="stylesheet" href="webapp/threeDView.css" type="text/css">
</head>
<body>
<div id="app">
    <div id="container"></div>
</div>

<script src="/webapp/monacoeditor.js"></script>
<script>
    window.registerUIThings = setInterval(() => {
        if (window.editor == undefined) return;
        clearInterval(window.registerUIThings);
    
        require(['Ember', 'cnc/ui/graphicView', 'cnc/cam/cam', 'cnc/util', 'cnc/ui/gcodeEditor', 'cnc/gcode/gcodeSimulation', 'templates'],
            function (Ember, GraphicView, cam, util, gcodeEditor, gcodeSimulation) {
                Ember.Handlebars.helper('num', function (value) {
                    return new Handlebars.SafeString(Handlebars.Utils.escapeExpression(util.formatCoord(value)));
                });
                Ember.TEMPLATES['application'] = Ember.TEMPLATES['camApp'];

                window.Simulator = Ember.Application.create({
                    rootElement: '#app'
                });

                Simulator.GcodeEditorComponent = gcodeEditor.GcodeEditorComponent;
                Simulator.GraphicView = GraphicView;

                Simulator.ApplicationController = Ember.ObjectController.extend({
                    init: function () {
                        this._super();
                        var _this = this;
                        $(window).on('dragover', function (event) {
                            event.preventDefault();
                            event.dataTransfer.dropEffect = 'move';
                        });

                        $(window).on('drop', function (evt) {
                            evt.preventDefault();
                            evt.stopPropagation();
                            var files = evt.dataTransfer.files;
                            var file = files[0];
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                _this.set('code', e.target.result);
                                _this.launchSimulation();
                            };
                            reader.readAsText(file);
                        });
                        this.launchSimulation();
                    },
                    actions: {
                        simulate: function () {
                            this.launchSimulation();
                        },
                        loadBigSample: function () {
                            this.set('computing', true);
                            var _this = this;
                            require(['text!samples/aztec_calendar.ngc'], function (text) {
                                _this.set('code', text);
                                _this.launchSimulation();
                            });
                        }
                    },
                    launchSimulation: function () {
                        var _this = this;

                        function handleResult(result) {
                            _this.flushFragmentFile();
                            var errors = [];
                            for (var i = 0; i < result.errors.length; i++) {
                                var error = result.errors[i];
                                errors.push({row: error.lineNo, text: error.message, type: "error"});
                            }
                            _this.set('errors', errors);
                            _this.set('bbox', {min: result.min, max: result.max});
                            _this.set('totalTime', result.totalTime);
                            _this.set('lineSegmentMap', result.lineSegmentMap);
                            _this.set('computing', false);
                            console.timeEnd('simulation');
                        }

                        console.time('simulation');
                        this.set('computing', true);
                        _this.set('lineSegmentMap', []);
                        this.get('simulatedPath').clear();
                        gcodeSimulation.parseInWorker(this.get('code'), new util.Point(0, 0, 0),
                                Ember.run.bind(_this, handleResult),
                                Ember.run.bind(_this, function (fragment) {
                                    _this.get('fragmentFile').pushObject(fragment);
                                    Ember.run.throttle(_this, _this.flushFragmentFile, 500);
                                }));
                    },
                    flushFragmentFile: function () {
                        this.get('simulatedPath').pushObjects(this.get('fragmentFile'));
                        this.get('fragmentFile').clear();
                    },
                    formattedTotalTime: function () {
                        var totalTime = this.get('totalTime');
                        var humanized = util.humanizeDuration(totalTime);
                        return {humanized: humanized, detailed: Math.round(totalTime) + 's'};
                    }.property('totalTime'),
                    currentHighLight: function () {
                        return this.get('lineSegmentMap')[this.get('currentRow')];
                    }.property('currentRow', 'lineSegmentMap').readOnly(),
                    code: '',//DEFAULT_EDITOR_VALUE
                    errors: [],
                    bbox: {},
                    totalTime: 0,
                    lineSegmentMap: [],
                    currentRow: null,
                    simulatedPath: [],
                    computing: false,
                    fragmentFile: [],
                    canSelectLanguage: false,
                    usingGcode: true,
                    decorations: []
                });
            });
        });
</script>

<script>
window.killMe = setInterval(() => {
    elem = document.getElementsByClassName('ember-view viewContainer');
    if (elem.length == 0) return;
    elem = elem[0];

    // make the position absolute, and move it to the top right
    elem.style.position = 'absolute';
    elem.style.top = '0';
    elem.style.right = '0';
    // make the max width 45% of the screen
    elem.style.maxWidth = '45%';

    document.getElementById('ember290').remove();
    document.getElementsByClassName('3DWarning')[0].remove();
    clearInterval(window.killMe);
}, 100);
</script>

</body>
</html>

<script>
    async function openLocalFile() {
        const [fileHandle] = await window.showOpenFilePicker();
        await fileHandle.requestPermission({mode: 'readwrite'});
        window.openFileHandle = fileHandle;

        fileHandle.getFile().then((file) => {
            file.text().then((text) => {
                window.editor.setValue(text);
            });
        });
    }

    async function saveLocalFile(handle){
        try {
            const stream = await handle.createWritable();
            await stream.write(editor.getValue());
            stream.close();
            new Popup('Saved!', 500);
        } catch (e){
            (console.error || console.log).call(console, e.stack || e);
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key == 'o'){
            e.preventDefault();
            openLocalFile();
        }
    });

    window.illdielater = setInterval(() => {
        if (document.getElementsByClassName('editBlock').length == 0 || window.editor == undefined) return;

        // Not a big fan of this code, but it used to be worse
        const editBlock = document.getElementsByClassName('editBlock')[0];

        // Hide original button & listen for keypresses (will be sent by our code)
        const origSimulateButton = document.getElementsByClassName('editBlock')[0].getElementsByTagName('button')[0];
        origSimulateButton.style.display = 'none';

        origSimulateButton.addEventListener('click', () => {
            window.clearMarkers(window.editor);
        })

        // Hide load big sample button
        const origLoadBigSampleButton = document.getElementsByClassName('editBlock')[0].getElementsByTagName('button')[1];
        origLoadBigSampleButton.style.display = 'none';

        // Create a new simulate button
        const newSimulateButton = document.createElement('button');
        newSimulateButton.classList.add('button');
        newSimulateButton.innerHTML = 'Simulate';
        newSimulateButton.style.marginRight = '5px';

        newSimulateButton.addEventListener('click', () => {
            window.TwoDForceUpdate = true;
            window.ThreeDForceUpdate = true;
            origSimulateButton.click();
        });
        
        // Create a open file button to replace load big sample
        const openFile = document.createElement('button');
        openFile.classList.add('button');
        openFile.innerHTML = 'Open File';

        openFile.addEventListener('click', openLocalFile);


        // Create the live reload checkbox
        const liveReloadCheckbox = document.createElement('input');
        liveReloadCheckbox.type = 'checkbox';
        liveReloadCheckbox.classList.add('checkbox');
        liveReloadCheckbox.id = 'liveReload';
        liveReloadCheckbox.checked = localStorage.getItem('liveReload') == 'true';

        liveReloadCheckbox.addEventListener('change', () => {
            localStorage.setItem('liveReload', liveReloadCheckbox.checked ? 'true' : 'false');
        });

        // Create a label for the live reload checkbox
        const liveReloadLabel = document.createElement('label');
        liveReloadLabel.innerHTML = 'Live Reload';
        liveReloadLabel.classList.add('checkbox-label');
        liveReloadCheckbox.for = 'liveReload';

        // Create a container for centering the checkbox?
        const liveReloadContainer = document.createElement('div');
        liveReloadContainer.style.display = 'inline';
        liveReloadContainer.append(liveReloadCheckbox, liveReloadLabel);



        // Create the suggestions toggle checkbox
        const suggestionsToggleCheckbox = document.createElement('input');
        suggestionsToggleCheckbox.type = 'checkbox';
        suggestionsToggleCheckbox.id = 'suggestionsToggle';
        suggestionsToggleCheckbox.classList.add('checkbox');
        suggestionsToggleCheckbox.checked = localStorage.getItem('suggestionsToggle') == 'true';

        // Create a label for the suggestions toggle checkbox
        const suggestionsToggleLabel = document.createElement('label');
        suggestionsToggleLabel.innerHTML = 'Suggestions';
        suggestionsToggleLabel.classList.add('checkbox-label')
        suggestionsToggleLabel.for = 'suggestionsToggle';

        suggestionsToggleCheckbox.addEventListener('change', () => {
            localStorage.setItem('suggestionsToggle', suggestionsToggleCheckbox.checked ? 'true' : 'false');
        });

        // Create a container for centering the checkbox?
        const suggestionsContainer = document.createElement('div');
        suggestionsContainer.style.display = 'inline';
        suggestionsContainer.append(suggestionsToggleCheckbox, suggestionsToggleLabel);

        

        // Create a container to hold the checkboxes (so they stack)
        const checkboxContainer = document.createElement('div');
        checkboxContainer.classList.add('toggleButtonContainer');
        
        checkboxContainer.append(liveReloadContainer, suggestionsContainer);


        // This toolbar goes under the editor and holds all the elements we just created
        const toolbarContainer = document.createElement('div');
        toolbarContainer.style.display = 'inline-flex';
        

        toolbarContainer.append(newSimulateButton, openFile);
        toolbarContainer.append(checkboxContainer);
        editBlock.insertBefore(toolbarContainer, origLoadBigSampleButton);

        clearInterval(illdielater);
    })
</script>

<style>
    body, html {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        position: absolute;
        height: 100%;
        width: 100%;
        margin: 0;
        background-color: #171616;
        color: white;
    }

    body {
        padding-left: 8px;
        padding-right: 8px;
        overflow: auto;
        overflow-x: hidden;
    }

    h1 {
        margin-top: 0;
    }

    #container {
        margin-top: 10px;
        margin-left: 10px;
        height: 600px;
        width: 45%;
    }

    .editBlock {
        position: relative;
        float: left;
        width: 39%;
        height: fit-content;
        padding: 1px;
        margin: 0;
        margin-left: 10px;
        margin-top: 10px;
    }

    .toggleButtonContainer {
        display: inline-flex;
        flex-direction: column;
    }

    .editBlock pre {
        width: 100%;
        height: 350px;
        margin: 0;
    }

    .viewContainer {
        float: right;
        width: 60%;
    }

    .button {
        display: inline-block;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007BFF; /* Button background color */
        color: #FFFFFF; /* Button text color */
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .button:hover {
        background-color: #0056b3; /* Button background color on hover */
    }

    #loader {
        display: inline-block;
        background-size: 100% 100%;
        background-image: url(webapp/images/spinner.svg);
        width: 20px;
        height: 20px;
    }

    .boundsTable {
        border-collapse: collapse;
    }

    .boundsTable td {
        border: dashed gray 1px;
        padding: 3px;
    }

    .ThreeDView {
        border: solid gray 1px;
        background: #000;
        height: 400px;
        position: relative;
    }

    .TwoDView {
        border: solid gray 1px;
        background: #000;
        height: 400px;
    }

    #app {
        position: relative;
    }
</style>